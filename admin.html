<!DOCTYPE html>
<html>
<head>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e90ff">
  <title>Admin Dashboard - Mini Wallet App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f0f2f5;
    }

    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 220px;
      height: 100%;
      background: #2c3e50;
      color: white;
      display: flex;
      flex-direction: column;
      transition: width 0.3s;
      overflow: hidden;
    }

    .sidebar.collapsed { width: 60px; }

    .sidebar h2 {
      text-align: center;
      padding: 20px 10px;
      margin: 0;
      font-size: 20px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .sidebar button {
      padding: 15px 20px;
      background: none;
      border: none;
      color: white;
      text-align: left;
      width: 100%;
      cursor: pointer;
      font-size: 16px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar button:hover { background: #34495e; }

    /* Main Content */
    .main {
      margin-left: 220px;
      padding: 20px;
      transition: margin-left 0.3s;
    }

    .main.sidebar-collapsed { margin-left: 60px; }

    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
    }

    input, textarea, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 16px;
    }

    button {
      background: #1e90ff;
      color: white;
      border: none;
      font-weight: bold;
      cursor: pointer;
    }

    button:hover { background: #187bcd; }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    table, th, td {
      border: 1px solid #ccc;
    }

    th, td {
      padding: 10px;
      text-align: left;
    }

    th { background: #f0f0f0; }

    .section { display: none; }
    .section.active { display: block; }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h2>Admin Panel</h2>
    <button onclick="toggleSidebar()" style="font-size:20px;">â˜°</button>
    <button onclick="showSection('dashboard')">Dashboard</button>
    <button onclick="showSection('addUser')">Add/Edit User</button>
    <button onclick="showSection('viewUsers')">View Users</button>
  </div>

  <!-- Main Content -->
  <div class="main" id="main">
    <!-- Dashboard -->
    <div id="dashboard" class="card section active">
      <h1>Welcome Admin!</h1>
      <p>Total Users: <span id="totalUsers">0</span></p>
    </div>

    <!-- Add/Edit User -->
    <div id="addUser" class="card section">
      <h1>Add / Edit User</h1>
      <input id="userCode" placeholder="User Code">
      <input id="userName" placeholder="User Name">
      <input id="userBalance" placeholder="Balance">
      <textarea id="userHistory" placeholder="Payment history (one per line)"></textarea>
      <button onclick="saveUser()">Save / Update User</button>
    </div>

    <!-- View Users -->
    <div id="viewUsers" class="card section">
      <h1>All Users</h1>
      <input id="searchUser" placeholder="Search by code or name" oninput="renderUsers()">
      <table>
        <thead>
          <tr>
            <th>Code</th>
            <th>Name</th>
            <th>Balance</th>
            <th>History</th>
            <th>Download</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
      <button onclick="downloadAllUsers()">Download All Users</button>
    </div>
  </div>

<script>
  // Sidebar toggle
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const main = document.getElementById('main');
    sidebar.classList.toggle('collapsed');
    main.classList.toggle('sidebar-collapsed');
  }

  // Show section
  function showSection(sectionId) {
    document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
    document.getElementById(sectionId).classList.add('active');
    if(sectionId === 'dashboard') updateDashboard();
    if(sectionId === 'viewUsers') renderUsers();
  }

  // Save user
  function saveUser() {
    const code = document.getElementById('userCode').value.trim();
    const name = document.getElementById('userName').value.trim();
    const balance = document.getElementById('userBalance').value.trim();
    const history = document.getElementById('userHistory').value.trim();

    if(!code || !name) return alert('User code and name are required');

    localStorage.setItem(code+'_name', name);
    localStorage.setItem(code+'_balance', balance);
    localStorage.setItem(code+'_history', history);

    alert('User saved successfully!');
    document.getElementById('userCode').value = '';
    document.getElementById('userName').value = '';
    document.getElementById('userBalance').value = '';
    document.getElementById('userHistory').value = '';
  }

  // Render users table
  function renderUsers() {
    const tbody = document.getElementById('userTable');
    tbody.innerHTML = '';
    const search = document.getElementById('searchUser').value.toLowerCase();

    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.endsWith('_name')) {
        const code = key.replace('_name','');
        const name = localStorage.getItem(code+'_name');
        const balance = localStorage.getItem(code+'_balance') || 0;
        const history = localStorage.getItem(code+'_history') || '';

        if(name.toLowerCase().includes(search) || code.toLowerCase().includes(search)) {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${code}</td>
            <td>${name}</td>
            <td>${balance}</td>
            <td><pre>${history}</pre></td>
            <td><button onclick="downloadUser('${code}')">Download</button></td>
            <td><button onclick="deleteUser('${code}')">Delete</button></td>
          `;
          tbody.appendChild(row);
        }
      }
    }
  }

  // Download a user's record
  function downloadUser(code) {
    const name = localStorage.getItem(code+'_name') || '';
    const balance = localStorage.getItem(code+'_balance') || '';
    const history = localStorage.getItem(code+'_history') || '';
    const text = `Name: ${name}\nBalance: ${balance}\n\nHistory:\n${history}`;

    const blob = new Blob([text], {type: 'text/plain'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${code}_record.txt`;
    link.click();
  }

  // Delete a user
  function deleteUser(code) {
    if(confirm(`Are you sure you want to delete user "${code}"?`)) {
      localStorage.removeItem(code+'_name');
      localStorage.removeItem(code+'_balance');
      localStorage.removeItem(code+'_history');
      renderUsers();
      updateDashboard();
      alert(`User "${code}" deleted.`);
    }
  }

  // Download all users
  function downloadAllUsers() {
    let text = '';
    for(let i=0; i<localStorage.length; i++) {
      const key = localStorage.key(i);
      if(key.endsWith('_name')) {
        const code = key.replace('_name','');
        const name = localStorage.getItem(code+'_name');
        const balance = localStorage.getItem(code+'_balance') || 0;
        const history = localStorage.getItem(code+'_history') || '';
        text += `Code: ${code}\nName: ${name}\nBalance: ${balance}\nHistory:\n${history}\n------------------\n`;
      }
    }

    const blob = new Blob([text], {type:'text/plain'});
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'all_users.txt';
    link.click();
  }

  // Update dashboard stats
  function updateDashboard() {
    let count = 0;
    for(let i=0;i<localStorage.length;i++){
      if(localStorage.key(i).endsWith('_name')) count++;
    }
    document.getElementById('totalUsers').innerText = count;
  }

  // Initialize
  showSection('dashboard');
  if ("serviceWorker" in navigator) {
  navigator.serviceWorker
    .register("sw.js")
    .then(() => console.log("Service Worker Registered"))
    .catch((err) => console.log("Service Worker Failed:", err));
}
</script>

</body>
</html>